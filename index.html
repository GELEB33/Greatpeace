<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чесночный фермер</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-family: Arial;
            border-radius: 5px;
            pointer-events: none;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            pointer-events: auto;
        }
        button:disabled {
            background: #777;
        }
        button.active {
            background: #2E7D32;
        }
        #inventory {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h3>Чесночный фермер</h3>
        <p>Кликните по полю для перемещения</p>
    </div>
    <div id="inventory">
        <p>Семена: <span id="seeds-count">10</span></p>
        <p>Чеснок: <span id="garlic-count">0</span></p>
    </div>
    <div id="controls">
        <button id="move-btn" class="active">Перемещение</button>
        <button id="plant-btn">Посадить</button>
        <button id="harvest-btn">Собрать</button>
    </div>

    <!-- Three.js и необходимые компоненты -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // Инициализация сцены
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        
        // Камера
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(15, 15, 15);
        
        // Рендерер
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // Управление камерой
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        // Освещение
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        // Параметры игры
        const fieldSize = 10;
        const cellSize = 1;
        const grid = [];
        let farmer = null;
        let targetPosition = null;
        let action = 'move';
        let seedsCount = 10;
        let garlicCount = 0;
        let walking = false;
        
        // Создание поля
        function createField() {
            // Земля
            const groundGeometry = new THREE.PlaneGeometry(fieldSize, fieldSize);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x3a5f0b,
                side: THREE.DoubleSide
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Сетка клеток
            const cellsCount = fieldSize / cellSize;
            for (let i = 0; i < cellsCount; i++) {
                grid[i] = [];
                for (let j = 0; j < cellsCount; j++) {
                    grid[i][j] = {
                        x: -fieldSize/2 + i*cellSize + cellSize/2,
                        z: -fieldSize/2 + j*cellSize + cellSize/2,
                        planted: false,
                        growthStage: 0,
                        plant: null
                    };
                }
            }
            
            // Разметка поля
            const gridHelper = new THREE.GridHelper(fieldSize, cellsCount);
            gridHelper.position.y = 0.01;
            scene.add(gridHelper);
        }
        
        // Создание персонажа
        function createFarmer() {
            // Тело
            const bodyGeometry = new THREE.BoxGeometry(0.4, 1, 0.2);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x4682B4 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.5;
            
            // Голова
            const headGeometry = new THREE.SphereGeometry(0.2);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.1;
            
            farmer = new THREE.Group();
            farmer.add(body);
            farmer.add(head);
            farmer.castShadow = true;
            scene.add(farmer);
        }
        
        // Обработка кликов
        function onFieldClick(event) {
            const mouse = new THREE.Vector2(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children);
            
            if (intersects.length > 0 && intersects[0].object === scene.children[0]) {
                const point = intersects[0].point;
                const i = Math.floor((point.x + fieldSize/2) / cellSize);
                const j = Math.floor((point.z + fieldSize/2) / cellSize);
                
                if (i >= 0 && i < grid.length && j >= 0 && j < grid[0].length) {
                    const cell = grid[i][j];
                    
                    if (action === 'plant' && !cell.planted && seedsCount > 0) {
                        plantGarlic(cell);
                    } else if (action === 'harvest' && cell.planted && cell.growthStage === 3) {
                        harvestGarlic(cell);
                    } else if (action === 'move') {
                        targetPosition = new THREE.Vector3(cell.x, 0, cell.z);
                        walking = true;
                    }
                }
            }
        }
        
        // Посадка чеснока
        function plantGarlic(cell) {
            cell.planted = true;
            seedsCount--;
            updateUI();
            
            targetPosition = new THREE.Vector3(cell.x, 0, cell.z);
            walking = true;
            
            // Создаем растение
            const plant = new THREE.Group();
            plant.position.set(cell.x, 0, cell.z);
            scene.add(plant);
            cell.plant = plant;
            
            growPlant(cell);
        }
        
        // Рост растения
        function growPlant(cell) {
            if (cell.growthStage >= 3) return;
            
            cell.growthStage++;
            
            // Очищаем предыдущую стадию
            while(cell.plant.children.length) {
                cell.plant.remove(cell.plant.children[0]);
            }
            
            // Создаем новую стадию
            const size = 0.1 * cell.growthStage;
            const stemGeometry = new THREE.CylinderGeometry(size/4, size/4, size, 6);
            const stemMaterial = new THREE.MeshStandardMaterial({ color: 0x00aa00 });
            const stem = new THREE.Mesh(stemGeometry, stemMaterial);
            stem.position.y = size/2;
            cell.plant.add(stem);
            
            if (cell.growthStage === 3) {
                const garlicGeometry = new THREE.SphereGeometry(size/2, 8, 8);
                const garlicMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const garlic = new THREE.Mesh(garlicGeometry, garlicMaterial);
                garlic.position.y = size;
                cell.plant.add(garlic);
            }
            
            if (cell.growthStage < 3) {
                setTimeout(() => growPlant(cell), 1000);
            }
        }
        
        // Сбор урожая
        function harvestGarlic(cell) {
            targetPosition = new THREE.Vector3(cell.x, 0, cell.z);
            walking = true;
            
            scene.remove(cell.plant);
            cell.planted = false;
            cell.plant = null;
            cell.growthStage = 0;
            
            garlicCount += 3;
            updateUI();
        }
        
        // Обновление интерфейса
        function updateUI() {
            document.getElementById('seeds-count').textContent = seedsCount;
            document.getElementById('garlic-count').textContent = garlicCount;
            
            document.getElementById('plant-btn').disabled = seedsCount <= 0;
            document.getElementById('harvest-btn').disabled = garlicCount <= 0;
        }
        
        // Управление кнопками
        document.getElementById('move-btn').addEventListener('click', () => {
            action = 'move';
            updateButtonStyles();
        });
        
        document.getElementById('plant-btn').addEventListener('click', () => {
            action = 'plant';
            updateButtonStyles();
        });
        
        document.getElementById('harvest-btn').addEventListener('click', () => {
            action = 'harvest';
            updateButtonStyles();
        });
        
        function updateButtonStyles() {
            document.querySelectorAll('#controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#${action}-btn`).classList.add('active');
        }
        
        // Обработка событий
        renderer.domElement.addEventListener('click', onFieldClick, false);
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Анимация
        function animate() {
            requestAnimationFrame(animate);
            
            // Движение персонажа
            if (targetPosition && farmer) {
                const direction = new THREE.Vector3()
                    .subVectors(targetPosition, farmer.position)
                    .normalize()
                    .multiplyScalar(0.05);
                
                if (farmer.position.distanceTo(targetPosition) > 0.1) {
                    farmer.position.add(direction);
                    farmer.lookAt(new THREE.Vector3(
                        targetPosition.x,
                        farmer.position.y,
                        targetPosition.z
                    ));
                    
                    // Анимация ходьбы
                    if (!walking) walking = true;
                    farmer.children[0].rotation.z = Math.sin(Date.now() * 0.01) * 0.2;
                } else {
                    walking = false;
                }
            }
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Инициализация
        createField();
        createFarmer();
        updateUI();
        updateButtonStyles();
        animate();
    </script>
</body>
</html>
